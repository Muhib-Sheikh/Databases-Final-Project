import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.Scanner;
import java.util.logging.Level;
import java.util.logging.Logger;
import java.util.Random;

public class DatabaseClass {

	static Scanner scanner = new Scanner(System.in);
	public static String host = "jdbc:mysql://cisvm-winsrv-mysql1.unfcsd.unf.edu:3307/group1";
	//String host2 = "jdbc:mysql://localhost:3306/group1";
	public static String username = "n01442744";
	public static String password = "V22d9569";
	public static String userEmail = null;
	public static String userID = null;
	public static String guest = null;
	public static String userPass = null;
	public static String adminPass = null;
	public static String ISBN;
	public static int choice = 0;
	static public String userString;
	public static  int idArray[] = {};
	public static boolean signedIn = false;
	public static double subtotal;
	public static String tempUserID;

	
	public static void main(String[] args) throws ClassNotFoundException {
	
			MainMenu();
			
	}
	
	public static void MainMenu() {
		System.out.println("Enter 1 for User Access and Enter 2 for Admin Access");
		choice = scanner.nextInt();
		
		if (choice == 1) {
			UserAccess();
		}
		
		if(choice == 2) {
			AdminAccess();
		}
		else {
			System.out.println("Invalid Option!");
			MainMenu();
		}
		
	}
	
	public static void AdminAccess() {
		System.out.println("Enter 1 to Locate Title\n"
				+  "Enter 2 to Update Inventory\n"
				+  "Enter 3 to Check User Balance and Late Fees\n"
				+  "Enter 4 to Generate Reports\n"
				+  "Enter 5 to Return");

		choice = scanner.nextInt();
		
		switch (choice) {
		case 1: 
			AdminSearch();
			break;
		case 2: 
			UpdateInventory();
			break;
		case 3:
			CheckUserBal();
			break;
		case 4:
			GenerateReports() ;
			break;
		case 5:
			 MainMenu();
			break;
		default:
			System.out.println("Not A Valid Option");
			AdminAccess();			
			break;
		}
	}
	public static void AdminSearch() {
		Scanner scan = new Scanner(System.in);
		System.out.print("Search by title, genre or author:\n");
		userString = scan.nextLine();
		//System.out.println(userString);
		//System.out.println("WHERE authors.FirstName LIKE \'" + userString + "\' OR authors.LastName LIKE \'" + userString + "\' OR books.Title LIKE \'" + userString + "\' OR books.ISBN LIKE \'" + userString + "\' OR genre.GenreName LIKE \'" + userString + "\'");
		// SQL code here to search tables for books by input.
		String query = "SELECT Title, authors.FirstName, authors.LastName , ISBN, Price, RentalPrice, genre.GenreName, publishers.PublisherName, format.`New/used`, `book format`.BookType , Inventory\r\n" + 
				"FROM books\r\n" + 
				"INNER JOIN `book authors` on `book authors`.BookID = books.BookID\r\n" + 
				"INNER JOIN genre on genre.GenreID = books.GenreID\r\n" + 
				"INNER JOIN publishers on publishers.PublisherID = books.PublisherID\r\n" + 
				"INNER JOIN `format` on format.`FormatID` = books.FormatID\r\n" + 
				"INNER JOIN `book format` on `book format`.BookTypeID = format.`BookTypeID`\r\n" + 
				"INNER JOIN authors on authors.AuthorID = `book authors`.AuthorID\r\n" + 
				"WHERE authors.FirstName LIKE \'" + userString + "\' OR authors.LastName LIKE \'" + userString + "\' OR books.Title LIKE \'"
				+ userString + "\' OR books.ISBN LIKE \'" + userString + "\' OR genre.GenreName LIKE \'" + userString + "\'" +
				"GROUP BY books.Title;";
			
		try (Connection con = DriverManager.getConnection(host, username, password);
                PreparedStatement pst = con.prepareStatement(query);
                ResultSet rs = pst.executeQuery()) {
			String arr[] = {};
			String var1, var2, var3, var4, var5, var6, var7, var8, var9, var10, var11;
			
			System.out.printf("%-40s %-10s %-15s %-15s %-10s %-14s %-30s %-10s %-8s %-15s %-10s %-1s\n","Title","First Name","Last Name","ISBN","Price","Rental Price","Genre","Publisher","Format","Condition","Inv", "");
			while (rs.next()) {
				
				var1 = rs.getString(1);
				var2 = rs.getString(2);
				var3 = rs.getString(3);
				var4 = rs.getString(4);
				var5 = rs.getString(5);
				var6 = rs.getString(6);
				var7 = rs.getString(7);
				var8 = rs.getString(8);
				var9 = rs.getString(9);
				var10 = rs.getString(10);
				var11 = rs.getString(11);
				System.out.printf("%-40s %-10s %-15s %-15s %-10s %-14s %-30s %-10s %-8s %-15s %-10s\n", var1,  var2,  var3,  var4,  var5,  var6,  var7,  var8,  var9,  var10,  var11);
				
				
            }
			
		}catch(SQLException ex) {
			Logger lgr = Logger.getLogger(DatabaseClass.class.getName());
            lgr.log(Level.SEVERE, ex.getMessage(), ex);
		}
		System.out.println();
		System.out.println("1 to Continue Searching\n" + "2 to Return to Menu\n");		
		choice = scan.nextInt();
		if(choice == 1) {
			Search();
		}
		else if(choice == 2) {
			UserAccess();
		}
		else {
			while(choice != 1 || choice != 2) {
				System.out.println("Invalid Option!\n");
				System.out.println("1 to Continue Searching\n" + "2 to Return to Menu\n");
				choice = scan.nextInt();
				if(choice == 1) {
					Search();
				}
				else if(choice == 2) {
					UserAccess();
				}
			}
		}
		
	}//end AdminSearch
	
	public static void UpdateInventory() {
	
	

	}
	
	public static void CheckUserBal() {
		
	}
	
	public static void GenerateReports() {
		
	}
	
	public static void UserAccess() {
		System.out.println("Enter 1 to Search\n"
				+  "Enter 2 to Checkout(rent)/buy\n"
				+  "Enter 3 for Returns\n"
				+  "Enter 4 to Check/Pay Balance and Late Fees\n"
				+  "Enter 5 to Log In\n"
				+  "Enter 6 to Create Account\n"
				+  "Enter 7 to Return to Main Menu");

		choice = scanner.nextInt();
		
		switch (choice) {
		case 1: 
			Search();
			break;
		case 2: 
			Cart();
			break;
		case 3:
			Return();
			break;
		case 4:
			Balance();
			break;
		case 5:
			LogIn();
			break;
		case 6: 
			CreateAccount();
		case 7:
			MainMenu();
			
		default:
			System.out.println("Not A Valid Option!\n");
			UserAccess();
		}
		
	}// end UserAccess
	
public static void Search() {
		Scanner scan = new Scanner(System.in);
		System.out.print("Search by title, genre or author:\n");
		userString = scan.nextLine();
		//System.out.println(userString);
		//System.out.println("WHERE authors.FirstName LIKE \'" + userString + "\' OR authors.LastName LIKE \'" + userString + "\' OR books.Title LIKE \'" + userString + "\' OR books.ISBN LIKE \'" + userString + "\' OR genre.GenreName LIKE \'" + userString + "\'");
		// SQL code here to search tables for books by input.
		String query = "SELECT Title, authors.Name, ISBN, Price, RentalPrice, genre.GenreName, publishers.PublisherName, format.`New/used`, `book format`.BookType , Inventory\r\n" + 
				"FROM books\r\n" +  
				"INNER JOIN genre on genre.GenreID = books.GenreID\r\n" + 
				"INNER JOIN publishers on publishers.PublisherID = books.PublisherID\r\n" + 
				"INNER JOIN `format` on format.`FormatID` = books.FormatID\r\n" + 
				"INNER JOIN `book format` on `book format`.BookTypeID = format.`BookTypeID`\r\n" + 
				"INNER JOIN authors on authors.AuthorID = `books`.AuthorID\r\n" + 
				"WHERE authors.Name LIKE \'%" + userString + "%\' OR " +
				"books.Title LIKE \'%" + userString + "%\' OR " +
			    "books.ISBN LIKE \'" + userString + "\' OR " +
				"genre.GenreName LIKE \'%" + userString + "%\'" +
				"GROUP BY books.Title;";
			
		try (Connection con = DriverManager.getConnection(host, username, password);
                PreparedStatement pst = con.prepareStatement(query);
                ResultSet rs = pst.executeQuery()) {
			String var1, var2, var3, var4, var5, var6, var7, var8, var9, var10;
			
			System.out.printf("%-90s %-30s %-20s %-10s %-14s %-30s %-40s %-15s %-16s %-10s %-1s\n","Title","Name","ISBN","Price","Rental Price","Genre","Publisher","Condition","Format","Inv", "");
			while (rs.next()) {
				
				var1 = rs.getString(1);
				var2 = rs.getString(2);
				var3 = rs.getString(3);
				var4 = rs.getString(4);
				var5 = rs.getString(5);
				var6 = rs.getString(6);
				var7 = rs.getString(7);
				var8 = rs.getString(8);
				var9 = rs.getString(9);
				var10 = rs.getString(10);
				System.out.printf("%-90s %-30s %-20s %-10s %-14s %-30s %-40s %-15s %-16s %-10s\n", var1,  var2,  var3,  var4,  var5,  var6,  var7,  var8,  var9,  var10);
				
            }
			
		}catch(SQLException ex) {
			Logger lgr = Logger.getLogger(DatabaseClass.class.getName());
            lgr.log(Level.SEVERE, ex.getMessage(), ex);
		}
		
		System.out.println();
		System.out.println("1 to Continue Searching\n"+ "2 to Add to Cart\n" + "3 to Return to Menu\n");		
		choice = scan.nextInt();
		if(choice == 1) {
			Search();
		}
		else if(choice == 2) {
			addToCart();
		}
		
		else if (choice == 3) {
			UserAccess();
		}
		else {
			while(choice != 1 || choice != 2 || choice != 3) {
				System.out.println("Invalid Option!\n");
				System.out.println("1 to Continue Searching\n" + "2 to Return to Menu\n");
				choice = scan.nextInt();
				if(choice == 1) {
					Search();
				}
				else if(choice == 2) {
					UserAccess();
				}
			}
		}
		
		System.out.println("userID: " + userID);		
		// Allow them to add items to shopping cart 
	}// end Search()
	


	public static void addToCart() {
		Random rand = new Random();
		int guestNumber = rand.nextInt(1000000);
		Scanner scan = new Scanner(System.in);
		
		if (userEmail == null && userPass == null) {
			System.out.println("Would you like to log in or create an account first?\n"
							+ "Enter 1 to create account\n"
							+ "Enter 2 to log in.\n"
							+ "Enter 3 to continue as guest");
			choice = scanner.nextInt();
			if (choice == 1) {
				CreateAccount();
				
			}
			
			else if (choice == 2) {
				LogIn();
			}
			
			else if (choice == 3) {
				userEmail = "guest";
				userPass = "guest";
				guest = "guest" + guestNumber;
				System.out.println(guest);
				createGuestAccount();
			}
			
			else  {
				while (choice != 1 || choice != 2 || choice !=3) {
					System.out.println("Invalid Option!");
					addToCart();
					
				}
			}
		}
		
		System.out.println("Enter ISBN of book you would like to add.");
		ISBN = scan.nextLine();
		System.out.println("Enter number of copies.\n");
		int Quantity = scan.nextInt();
		String query ="INSERT INTO `shopping cart` (UserID, BookID, BookTitle, Quantity, Price) VALUES (\r\n" + 
				"    (SELECT UserId FROM users WHERE Email IN ('" + userEmail + "')),\r\n" + 
				"    (SELECT BookID FROM books WHERE ISBN IN ('" + ISBN + "')),\r\n" + 
				"	(SELECT Title FROM books WHERE ISBN IN ('" + ISBN + "')),\r\n" + 
				     Quantity + ",\r\n" + 
				"	(SELECT Price FROM books WHERE ISBN IN ('" + ISBN + "'))	\r\n" + 
				");";
		
		  try  (Connection con = DriverManager.getConnection(host, username, password)) {
			
            Statement s = con.createStatement();
            s.executeUpdate(query);
            System.out.println("Item added to cart!");
			
		}catch(SQLException ex) {
			Logger lgr = Logger.getLogger(DatabaseClass.class.getName());
            lgr.log(Level.SEVERE, ex.getMessage(), ex);
		}
		 
		
		
		
	}// end addToCart()
	
	public static void Cart() {//checkout
		//SELECT
		//lets customers and users look at their current shopping cart.
		//They can rent/purchase from here and also remove
		
String query = "SELECT DISTINCT `shopping cart`.BookTitle, `shopping cart`.Quantity, `shopping cart`.Price, sum(`shopping cart`.Quantity * `shopping cart`.Price) \r\n" + 
		"FROM `shopping cart`\r\n" + 
		"WHERE UserID = '" + userID +"'\r\n" + 
		"GROUP BY `shopping cart`.BookID "
		+ "WITH ROLLUP;";
System.out.println(query);
System.out.println("userEmail: " + userEmail);
System.out.printf("%-90s %-10s %-10s \n", "Title",  "Quantity",  "Price");
	
		try (Connection con = DriverManager.getConnection(host, username, password);
                PreparedStatement pst = con.prepareStatement(query);
                ResultSet rs = pst.executeQuery()) {
			String title;
			int quantity;
			double price;	
			
			while (rs.next()) {
				title = rs.getString(1);
				quantity = rs.getInt(2);
				price = rs.getDouble(3);
				subtotal = rs.getDouble(4);
				System.out.printf("%-90s %-10d %-10.2f \n", title,  quantity,  price);
				
            }
		}catch(SQLException ex) {
			Logger lgr = Logger.getLogger(DatabaseClass.class.getName());
            lgr.log(Level.SEVERE, ex.getMessage(), ex);
		}
		System.out.printf("\t\t\t\t\t\t\t\t\t\t\t    Subtotal: %.2f\n", subtotal);
		System.out.println("If you would like to remove an item enter 1\n"
						 + "If you would like to rent/purchase an item enter 2\n"
						 + "To return to menu enter 3\n");
		choice = scanner.nextInt();
			if (choice == 1) {
				System.out.println("Enter the ID of item you would like to remove or 0 to return to cart.");
				choice = scanner.nextInt();
			}
			
			else if (choice == 2) {
				System.out.println("Enter the IDs separated by a space of item you would like to rent/purchase");
				choice = scanner.nextInt();
				/*
				 * for loop to turn each id into a separate element in idArray[]
				 * that way we can use each element to create orders from the cart
				 */
				// ask for payment method if required to go this deep
				// if user has a payment method stored on account don't ask
				//print a receipt
				Cart();
			}
			
			else if (choice == 3) {
				
				UserAccess();
			}
			
			
			
	}// end Cart()
	
	public static void Return () {
		// DISPLAY Books currently checked out with ID 
		System.out.println("Enter ID of book you would like to return or 0 to return to User Menu");
		choice = scanner.nextInt();
		if (choice == 0) {
			UserAccess();
		}
		//if statement to make sure choice == one of the IDS
		//if choice == ID then set return value to true or 1 then call Return();
		else {
			System.out.println("Enter correct ID");
			Return();
		}
	}	
	public static void Balance () {
		//print balance and late fees
		//let user pay one or both
	}
	
	public static void LogIn() {
		Scanner scan1 = new Scanner(System.in);
		String var1, var2, var3;
		System.out.println("Email: ");
		userEmail = scan1.nextLine();
		//if userEmail != an email in database then prompt user to enter again
		//else
		String query1 = "SELECT Email, Password, FirstName, UserID " + 
				"FROM users;";
			try  (Connection con = DriverManager.getConnection(host, username, password);
	
						PreparedStatement pst = con.prepareStatement(query1);
						ResultSet rs = pst.executeQuery()) {
	
					while (rs.next()) {
						var1 = rs.getString(1);
						var2 = rs.getString(2);
						var3 = rs.getString(3);
						userID = rs.getString(4);
						
							if (var1.compareToIgnoreCase(userEmail) == 0) {
								System.out.println("Password: ");
								userPass = scan1.nextLine();
								
								if (var1.compareToIgnoreCase(userEmail) == 0 && var2.compareToIgnoreCase(userPass) == 0) {
									System.out.println("Login Successful!\n");
									System.out.println("Welcome: " + var3);
									signedIn = true;
									UserAccess();
								}// end first if
								else {
									System.out.println("Password was incorrect!");
									System.out.println("Enter 1 to try again\n" + "Enter 2 to create account\n");
									choice = scan1.nextInt();
									
									if(choice == 1) {
										LogIn();
									}
									else if(choice == 2) {
										CreateAccount();
									}
									else {
										while(choice != 1 || choice != 2) {
											System.out.println("Invalid Option!");
											choice = scan1.nextInt();
										}
									}
								}
							}// end first if
						
					}//end while
					if(signedIn == false) {
					System.out.println("Email was incorrect!");
					
					
					System.out.println("Enter 1 to try again\n" + "Enter 2 to create account\n");
					choice = scan1.nextInt();
					
					if(choice == 1) {
						LogIn();
					}
					else if(choice == 2) {
						CreateAccount();
					}
					else {
						while(choice != 1 || choice != 2) {
							System.out.println("Invalid Option!");
							choice = scan1.nextInt();
						}
					}
					
				}
			//scan.close();
			}catch(SQLException ex) {
				Logger lgr = Logger.getLogger(DatabaseClass.class.getName());
				lgr.log(Level.SEVERE, ex.getMessage(), ex);
			}
		while(true) {
		UserAccess();
		}
		//System.out.println("Password: ");
		//userPass = scanner.nextLine();
		//if userPassword != an email in database then prompt user to enter again
		
	}
	
	public static void CreateAccount () {
		Scanner scan = new Scanner(System.in);
		String firstName;
		String lastName;
		String confirmEmail;
		String confirmPass;
		
		//code to create account
		System.out.println("Enter First Name");
			firstName = scan.nextLine();
		System.out.println("Enter Last Name");
			lastName = scan.nextLine();
		System.out.println("Enter Email");
			userEmail = scan.nextLine();
			CheckEmail();
		System.out.println("Confirm Email");
			confirmEmail = scan.nextLine();
		while (confirmEmail.compareToIgnoreCase(userEmail) != 0)
		{
			System.out.println("One of your values did not match.");
			System.out.println("Enter Email");
			userEmail = scan.nextLine();
			
			System.out.println("Confirm Email");
			confirmEmail = scan.nextLine();
		}
		System.out.println("Enter Password");
			userPass = scan.nextLine();
		System.out.println("Confirm Password");	
			confirmPass = scan.nextLine();
			
		while (confirmPass.compareToIgnoreCase(userPass) != 0) {
			
			System.out.println("One of your values did not match.");
			System.out.println("Enter Password");
				userPass = scan.nextLine();
			System.out.println("Confirm Password");	
				confirmPass = scan.nextLine();
		}
		
	String query = "INSERT INTO `group1`.`users` (`FirstName`, `LastName`, `Email`, `Password`) VALUES ('"+ firstName +"', '"+ lastName +"', '" + userEmail + "', '" + userPass +"');";
		
		try  (Connection con = DriverManager.getConnection(host, username, password)) {
		
            Statement s = con.createStatement();
            s.executeUpdate(query);
            System.out.println("Account Created!");
			
		}catch(SQLException ex) {
			Logger lgr = Logger.getLogger(DatabaseClass.class.getName());
            lgr.log(Level.SEVERE, ex.getMessage(), ex);
		}
		//scan.close();
		UserAccess();
		
	}// end Create Account
	
	public static void createGuestAccount() {
		String query = "INSERT INTO `group1`.`users` (`FirstName`, `LastName`, `Email`, `Password`) VALUES ('guest', 'guest', '" + guest + "', 'guest' );";
		try  (Connection con = DriverManager.getConnection(host, username, password)) {
			
            Statement s = con.createStatement();
            s.executeUpdate(query);
            System.out.println("Guest Account Created!");
			
		}catch(SQLException ex) {
			Logger lgr = Logger.getLogger(DatabaseClass.class.getName());
            lgr.log(Level.SEVERE, ex.getMessage(), ex);
		}

	}
	
	public static void CheckEmail() {
		Scanner scan1 = new Scanner(System.in);
		//int var = Integer.parseInt(scan1.nextLine());
		String var1;
		String query1 = "SELECT Email " + 
				"FROM users;";
			try  (Connection con = DriverManager.getConnection(host, username, password);
	
						PreparedStatement pst = con.prepareStatement(query1);
						ResultSet rs = pst.executeQuery()) {
	
					while (rs.next()) {
						var1 = rs.getString(1);
							if (var1.compareToIgnoreCase(userEmail) == 0) {
									System.out.println("The email you entered is already in use. Please enter another.\n"
													+ "Enter 1 to continue or Enter 2 to Log In");
														choice = Integer.parseInt(scan1.nextLine());
				
														if (choice == 1) {
															System.out.print("Enter another email: ");
															userEmail = scan1.nextLine();
															CheckEmail();
					
														} // end second if
														
														else if (choice == 2) {
															LogIn();
														}
							}// end first if
		
					}//end while
			//scan.close();
			}catch(SQLException ex) {
				Logger lgr = Logger.getLogger(DatabaseClass.class.getName());
				lgr.log(Level.SEVERE, ex.getMessage(), ex);
			}
		
	}// end Check email
	
	
}//end clientProgram
